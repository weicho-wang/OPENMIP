name: Build and Package OPENMIP

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache SuperBuild
        uses: actions/cache@v4
        with:
          path: |
            build/VTK-build
            build/ITK-build
            build/CTK-build
          key: ${{ runner.os }}-superbuild-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-superbuild-

      - name: Install Dependencies
        run: |
          set -e
          for i in 1 2 3; do
            sudo apt-get update && break
            if [ "$i" -eq 3 ]; then exit 1; fi
            sleep 10
          done
          for i in 1 2 3; do
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
              git subversion build-essential \
              cmake ninja-build \
              qtbase5-dev qtbase5-private-dev qttools5-dev \
              libqt5xmlpatterns5-dev libqt5svg5-dev \
              qtwebengine5-dev qtscript5-dev \
              libqt5x11extras5-dev libxt-dev \
              libssl-dev \
              qtmultimedia5-dev && break
            if [ "$i" -eq 3 ]; then exit 1; fi
            sleep 10
          done

      - name: Environment Snapshot (Linux)
        run: |
          uname -a
          cmake --version
          ninja --version
          df -h

      - name: Configure OPENMIP
        run: |
          mkdir -p build
          cd build
          cmake \
            -DCMAKE_BUILD_TYPE:STRING=Release \
            -DSlicer_MAIN_PROJECT:STRING=SlicerApp \
            -DSlicer_RELEASE_TYPE:STRING=Stable \
            -DSlicer_BUILD_DICOM_SUPPORT:BOOL=ON \
            -DSlicer_BUILD_DIFFUSION_SUPPORT:BOOL=ON \
            -DSlicer_BUILD_I18N_SUPPORT:BOOL=ON \
            -GNinja \
            ..

      - name: Build OPENMIP
        run: |
          cd build
          cmake --build . --parallel 4
        timeout-minutes: 300

      - name: Package OPENMIP (Linux)
        run: |
          cd build/Slicer-build
          cmake --build . --target package
        timeout-minutes: 60

      - name: List Package Files (Linux)
        if: always()
        run: |
          ls -lah build/Slicer-build || true
          find build/Slicer-build -maxdepth 4 -type f \( -name "*.tar.gz" -o -name "*.deb" \) | sort || true

      - name: Upload Linux Package
        uses: actions/upload-artifact@v4
        with:
          name: openmip-linux-package
          path: |
            build/Slicer-build/*.tar.gz
            build/Slicer-build/*.deb
          retention-days: 7
          if-no-files-found: warn

      - name: Upload Linux Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openmip-linux-diagnostics
          path: |
            build/CMakeCache.txt
            build/CMakeFiles/CMakeOutput.log
            build/CMakeFiles/CMakeError.log
            build/Slicer-build/CMakeCache.txt
            build/Slicer-build/CMakeFiles/CMakeOutput.log
            build/Slicer-build/CMakeFiles/CMakeError.log
            build/Slicer-build/_CPack_Packages/**
          retention-days: 7
          if-no-files-found: warn

  build-windows-deps:
    runs-on: windows-2022
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "5.15.2"
          host: "windows"
          target: "desktop"
          arch: "win64_msvc2019_64"
          modules: "qtwebengine qtscript"
          setup-python: "false"

      - name: Cache Windows Dependencies
        id: deps-cache
        uses: actions/cache@v4
        with:
          path: |
            build/VTK-build
            build/VTK
            build/ITK-build
            build/ITK
            build/CTK-build
            build/CTK
          key: windows-deps-${{ hashFiles('SuperBuild.cmake', 'CMakeLists.txt') }}
          restore-keys: |
            windows-deps-

      - name: Configure OPENMIP (Windows Dependencies)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          if (-not (Test-Path "build")) { New-Item -ItemType Directory "build" | Out-Null }
          $cmakeArgs = @(
            "-G", "Visual Studio 17 2022",
            "-A", "x64",
            "-DQt5_DIR:PATH=$env:Qt5_DIR",
            "-DCMAKE_BUILD_TYPE:STRING=Release",
            "-DSlicer_MAIN_PROJECT:STRING=SlicerApp",
            "-DSlicer_RELEASE_TYPE:STRING=Stable",
            "-DSlicer_BUILD_DICOM_SUPPORT:BOOL=ON",
            "-DSlicer_BUILD_DIFFUSION_SUPPORT:BOOL=ON",
            "-DSlicer_BUILD_I18N_SUPPORT:BOOL=ON",
            "-DSlicer_USE_PYTHONQT:BOOL=ON",
            "-DSlicer_USE_PYTHONQT_WITH_OPENSSL:BOOL=ON",
            "-DSlicer_USE_SYSTEM_python:BOOL=OFF",
            ".."
          )
          Push-Location build
          try {
            & cmake @cmakeArgs
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          } finally {
            Pop-Location
          }

      - name: Build VTK/ITK/CTK Dependencies
        if: steps.deps-cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd build
          cmake --build . --config Release --target VTK ITK CTK --parallel 4
        timeout-minutes: 330

      - name: Validate deps before upload
        shell: powershell
        run: |
          $paths = @(
            "build/VTK-build",
            "build/VTK",
            "build/ITK-build",
            "build/ITK",
            "build/CTK-build",
            "build/CTK"
          )
          $missing = @()
          foreach ($p in $paths) {
            if (-not (Test-Path $p)) { $missing += $p }
          }
          if ($missing.Count -gt 0) {
            Write-Error "Missing: $($missing -join ', ')"
            exit 1
          }
          Get-ChildItem build | Format-Table Name, Length, LastWriteTime

      - name: Upload Windows Dependency Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openmip-windows-deps
          path: |
            build/VTK-build
            build/VTK
            build/ITK-build
            build/ITK
            build/CTK-build
            build/CTK
            !build/VTK/.git/**
            !build/ITK/.git/**
            !build/CTK/.git/**
          retention-days: 7
          if-no-files-found: error

  build-windows:
    needs: build-windows-deps
    runs-on: windows-2022
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "5.15.2"
          host: "windows"
          target: "desktop"
          arch: "win64_msvc2019_64"
          modules: "qtwebengine qtscript"
          setup-python: "false"

      - name: Install NSIS
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          for ($i = 1; $i -le 3; $i++) {
            try {
              choco install nsis --no-progress --yes
              break
            } catch {
              if ($i -eq 3) { throw }
              Start-Sleep -Seconds 15
            }
          }

      - name: Download Windows Dependency Artifact
        uses: actions/download-artifact@v4
        with:
          name: openmip-windows-deps
          path: ${{ github.workspace }}/build

      - name: Verify downloaded deps
        shell: powershell
        run: |
          if (-not (Test-Path "build")) {
            Write-Error "Deps artifact missing: build/ not found in workspace."
            Get-ChildItem . | Format-Table Name, LastWriteTime
            exit 1
          }

          Write-Host "=== Debug: top-level under build ==="
          Get-ChildItem build -Force | Select-Object Name, Mode, LastWriteTime | Format-Table -AutoSize

          Write-Host "=== Debug: depth-2 directories under build ==="
          Get-ChildItem build -Directory -Recurse -Depth 2 -ErrorAction SilentlyContinue |
            Select-Object FullName, LastWriteTime |
            Format-Table -AutoSize

          Write-Host "=== Debug: key marker files (first 20) ==="
          Get-ChildItem build -Recurse -File -ErrorAction SilentlyContinue |
            Where-Object {
              $_.Name -in @("vtkModule.cmake", "ITKModuleAPI.cmake", "CMakeLists.txt", "CMakeCache.txt")
            } |
            Select-Object -First 20 FullName, Length, LastWriteTime |
            Format-Table -AutoSize

          $requiredPaths = @(
            "build/VTK-build",
            "build/VTK",
            "build/VTK/CMake/vtkModule.cmake",
            "build/ITK-build",
            "build/ITK",
            "build/ITK/CMake/ITKModuleAPI.cmake",
            "build/CTK-build",
            "build/CTK",
            "build/CTK/CMakeLists.txt"
          )

          $missing = @()
          foreach ($p in $requiredPaths) {
            if (-not (Test-Path $p)) { $missing += $p }
          }

          if ($missing.Count -gt 0) {
            Write-Error "Missing downloaded dependency paths: $($missing -join ', ')"
            Get-ChildItem build -ErrorAction SilentlyContinue | Format-Table Name, LastWriteTime
            exit 1
          }

          Get-ChildItem build | Format-Table Name, LastWriteTime

      - name: Environment Snapshot (Windows)
        shell: powershell
        run: |
          cmake --version
          Get-PSDrive -PSProvider FileSystem
          Get-ChildItem Env: | Sort-Object Name

      - name: Configure OPENMIP (Reuse Dependency Artifact)
        shell: powershell
        run: |
          # Artifact is downloaded to ${GITHUB_WORKSPACE}/build.
          # So dependencies land at: build\VTK-build, build\VTK, build\ITK-build, etc.
          $depsRoot = Join-Path $PWD "build"

          $requiredPaths = @(
            "$depsRoot\VTK-build",
            "$depsRoot\VTK",
            "$depsRoot\VTK\CMake\vtkModule.cmake",
            "$depsRoot\ITK-build",
            "$depsRoot\ITK",
            "$depsRoot\ITK\CMake\ITKModuleAPI.cmake",
            "$depsRoot\CTK-build",
            "$depsRoot\CTK",
            "$depsRoot\CTK\CMakeLists.txt"
          )

          $failed = $false
          foreach ($p in $requiredPaths) {
            if (-not (Test-Path $p)) {
              Write-Host "ERROR: Missing $p"
              $parent = Split-Path $p -Parent
              if (Test-Path $parent) {
                Write-Host "Contents of $parent :"
                Get-ChildItem $parent | Format-Table Name, LastWriteTime | Out-String | Write-Host
              } else {
                Write-Host "Parent directory $parent also does not exist."
                Write-Host "Contents of $depsRoot :"
                Get-ChildItem $depsRoot -ErrorAction SilentlyContinue | Format-Table Name | Out-String | Write-Host
              }
              $failed = $true
            }
          }
          if ($failed) { exit 1 }

          if (-not (Test-Path "build")) { New-Item -ItemType Directory "build" | Out-Null }

          $cmakeArgs = @(
            "-G", "Visual Studio 17 2022",
            "-A", "x64",
            "-DQt5_DIR:PATH=$env:Qt5_DIR",
            "-DCMAKE_BUILD_TYPE:STRING=Release",
            "-DSlicer_MAIN_PROJECT:STRING=SlicerApp",
            "-DSlicer_RELEASE_TYPE:STRING=Stable",
            "-DSlicer_BUILD_DICOM_SUPPORT:BOOL=ON",
            "-DSlicer_BUILD_DIFFUSION_SUPPORT:BOOL=ON",
            "-DSlicer_BUILD_I18N_SUPPORT:BOOL=ON",
            "-DSlicer_USE_PYTHONQT:BOOL=ON",
            "-DSlicer_USE_PYTHONQT_WITH_OPENSSL:BOOL=ON",
            "-DSlicer_USE_SYSTEM_python:BOOL=OFF",
            "-DVTK_DIR:PATH=$depsRoot\VTK-build",
            "-DVTK_SOURCE_DIR:PATH=$depsRoot\VTK",
            "-DITK_DIR:PATH=$depsRoot\ITK-build",
            "-DCTK_DIR:PATH=$depsRoot\CTK-build",
            ".."
          )

          Push-Location build
          try {
            Write-Host "Running: cmake $cmakeArgs"
            & cmake @cmakeArgs
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          } finally {
            Pop-Location
          }

      - name: Build OPENMIP
        shell: cmd
        run: |
          cd build
          cmake --build . --config Release --parallel 4
        timeout-minutes: 300

      - name: Verify VTK Python artifacts before packaging
        shell: powershell
        run: |
          $candidateRoots = @(
            "build/VTK-build",
            "build/python-install"
          )

          $vtkInitCandidates = @()
          foreach ($root in $candidateRoots) {
            if (Test-Path $root) {
              $vtkInitCandidates += Get-ChildItem -Path $root -Recurse -File -Filter "__init__.py" -ErrorAction SilentlyContinue |
                Where-Object { $_.FullName -match "vtkmodules" }
            }
          }

          if ($vtkInitCandidates.Count -eq 0) {
            Write-Error "vtkmodules was not found under expected build roots (build/VTK-build, build/python-install)."
            foreach ($root in $candidateRoots) {
              if (Test-Path $root) {
                Write-Host "=== Listing potential python dirs under $root ==="
                Get-ChildItem -Path $root -Recurse -Directory -ErrorAction SilentlyContinue |
                  Where-Object { $_.FullName -match "Python|site-packages|vtk" } |
                  Select-Object -First 80 FullName |
                  Format-Table -AutoSize
              }
            }
            exit 1
          }

          Write-Host "Found vtkmodules init files:"
          $vtkInitCandidates | Select-Object -First 20 FullName | Format-Table -AutoSize

      - name: Package OPENMIP (Windows)
        shell: cmd
        run: |
          cd build\Slicer-build
          cmake --build . --config Release --target PACKAGE
        timeout-minutes: 60

      - name: Smoke test packaged Python vtk import
        shell: powershell
        run: |
          $packageRoot = "build/Slicer-build/_CPack_Packages"
          if (-not (Test-Path $packageRoot)) {
            Write-Error "CPack output not found: $packageRoot"
            exit 1
          }

          $pythonSlicer = Get-ChildItem -Path $packageRoot -Recurse -File -Filter "PythonSlicer.exe" -ErrorAction SilentlyContinue |
            Select-Object -First 1
          if (-not $pythonSlicer) {
            Write-Error "PythonSlicer.exe not found in CPack staging tree."
            Get-ChildItem -Path $packageRoot -Recurse -File -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -match "OPENMIP|Slicer|LauncherSettings|python" } |
              Select-Object -First 80 FullName |
              Format-Table -AutoSize
            exit 1
          }

          $launcherSettings = Get-ChildItem -Path $packageRoot -Recurse -File -Filter "*LauncherSettings.ini" -ErrorAction SilentlyContinue |
            Select-Object -First 1
          if (-not $launcherSettings) {
            Write-Error "LauncherSettings.ini not found in CPack staging tree."
            exit 1
          }

          Write-Host "Using Python launcher: $($pythonSlicer.FullName)"
          & "$($pythonSlicer.FullName)" -c "import vtk, slicer; print(vtk.VTK_VERSION)"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "PythonSlicer smoke test failed: unable to import vtk/slicer."
            exit $LASTEXITCODE
          }

          $iniContent = Get-Content -Path $launcherSettings.FullName -ErrorAction Stop
          if (-not ($iniContent -match "bin/Python")) {
            Write-Error "LauncherSettings missing bin/Python in PYTHONPATH: $($launcherSettings.FullName)"
            exit 1
          }
          if (-not ($iniContent -match "site-packages")) {
            Write-Warning "LauncherSettings does not contain site-packages explicitly: $($launcherSettings.FullName)"
          }
          Write-Host "Launcher settings check passed: $($launcherSettings.FullName)"

      - name: List Package Files (Windows)
        if: always()
        shell: powershell
        run: |
          if (Test-Path build/Slicer-build) {
            Get-ChildItem -Path build/Slicer-build -Recurse -File -Include *.exe,*.msi,*.zip | Select-Object FullName, Length, LastWriteTime
          }

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: openmip-windows-installer
          path: |
            build/Slicer-build/_CPack_Packages/*/NSIS/*.exe
            build/Slicer-build/*.exe
          retention-days: 7
          if-no-files-found: error

      - name: Upload Windows Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openmip-windows-diagnostics
          path: |
            build/CMakeCache.txt
            build/CMakeFiles/CMakeOutput.log
            build/CMakeFiles/CMakeError.log
            build/Slicer-build/CMakeCache.txt
            build/Slicer-build/CMakeFiles/CMakeOutput.log
            build/Slicer-build/CMakeFiles/CMakeError.log
            build/Slicer-build/_CPack_Packages/**
          retention-days: 7
          if-no-files-found: warn

  build-macos:
    runs-on: macos-13
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          set -e
          for i in 1 2 3; do
            brew update && break
            if [ "$i" -eq 3 ]; then exit 1; fi
            sleep 10
          done
          for i in 1 2 3; do
            brew install \
              cmake ninja \
              qt@5 \
              subversion && break
            if [ "$i" -eq 3 ]; then exit 1; fi
            sleep 10
          done

      - name: Environment Snapshot (macOS)
        run: |
          sw_vers
          cmake --version
          ninja --version
          df -h

      - name: Configure OPENMIP
        run: |
          mkdir -p build
          cd build
          QT5_CMAKE_DIR="$(brew --prefix qt@5)/lib/cmake/Qt5"
          cmake \
            -DCMAKE_BUILD_TYPE:STRING=Release \
            -DSlicer_MAIN_PROJECT:STRING=SlicerApp \
            -DSlicer_RELEASE_TYPE:STRING=Stable \
            -DSlicer_BUILD_DICOM_SUPPORT:BOOL=ON \
            -DSlicer_BUILD_DIFFUSION_SUPPORT:BOOL=ON \
            -DSlicer_BUILD_I18N_SUPPORT:BOOL=ON \
            -DQt5_DIR:PATH=${QT5_CMAKE_DIR} \
            -GNinja \
            ..

      - name: Build OPENMIP
        run: |
          cd build
          cmake --build . --parallel 4
        timeout-minutes: 300

      - name: Package OPENMIP (macOS)
        run: |
          cd build/Slicer-build
          cmake --build . --target package
        timeout-minutes: 60

      - name: List Package Files (macOS)
        if: always()
        run: |
          ls -lah build/Slicer-build || true
          find build/Slicer-build -maxdepth 4 -type f -name "*.dmg" | sort || true

      - name: Upload macOS Package
        uses: actions/upload-artifact@v4
        with:
          name: openmip-macos-package
          path: build/Slicer-build/*.dmg
          retention-days: 7
          if-no-files-found: warn

      - name: Upload macOS Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openmip-macos-diagnostics
          path: |
            build/CMakeCache.txt
            build/CMakeFiles/CMakeOutput.log
            build/CMakeFiles/CMakeError.log
            build/Slicer-build/CMakeCache.txt
            build/Slicer-build/CMakeFiles/CMakeOutput.log
            build/Slicer-build/CMakeFiles/CMakeError.log
            build/Slicer-build/_CPack_Packages/**
          retention-days: 7
          if-no-files-found: warn
